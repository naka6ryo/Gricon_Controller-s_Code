# Gricon_Controller-s_Code

2024/12/27に桃山大学テック部主催で開催されたハッカソンに出展した作品 **Gricon** のコントローラー側プログラムです（2024/12/28 時点）。

このArduinoプログラムは、IMU（姿勢センサ）、曲げセンサ、モーターを統合し、姿勢推定・屈曲検出・振動出力を通じて新しい入力体験を提供します。

---

## 🔗 関連リンク

- 🎮 **ゲーム側のプログラム（Unity）**  
  https://github.com/kdix-23-240/NewControllerProject-MomoyamaHack

- 📄 **作品に関する情報・ソースコードの解説・開発の流れの説明（Notion）**  
  https://flossy-band-678.notion.site/Gricon-Arduino-Unity-16a9ff2ca96c8032b9a5cc3768512383?pvs=4

---

## 📌 特徴 / Features

- **9軸IMUセンサ（LSM9DS1）** によるピッチ・ロール・ヨーの推定  
- **Madgwickフィルタ** による高精度な姿勢推定  
- **曲げセンサ** を使ったアナログ入力処理と平滑化  
- **加速度のグローバル変換・振動検出** によるリアクティブ入力対応  
- **振動モーター出力** を通じたハプティクスフィードバック  
- **シリアル通信** による外部機器（ゲーム）との双方向連携  

---

## 🔧 使用ハードウェア

- Arduino Nano 33 BLE Sense または LSM9DS1 搭載の互換ボード  
- 曲げセンサ（アナログ入力：A7）  
- 振動モーター（デジタル出力：D9）  
- 外部通信：Serial1（9600bps）

---

## 📤 センサ出力フォーマット

コントローラは以下のフォーマットで**バイナリ形式**のデータを送信します。

[S][pitch (2 bytes)][roll (2 bytes)][yaw (2 bytes)][bend (1 byte)]


- `S`: データ開始を示すヘッダ（1バイト）  
- `pitch`, `roll`, `yaw`: 姿勢角（各2バイト、0.1°単位）  
- `bend`: 曲げセンサ値（0〜20の範囲にクランプ）

---

## 🔁 モーター制御プロトコル（Serial1 受信）

シリアル経由で以下の1文字コマンドを送ることで、モーターの振動出力パターンを変更可能：

| コマンド | 周波数 (Hz相当) | デューティ比 | 内容             |
|----------|------------------|--------------|------------------|
| `'1'`    | 約25Hz           | 40%          | 弱い振動         |
| `'2'`    | 約50Hz           | 20%          | 中程度の振動     |
| `'3'`    | 約100Hz          | 12.5%        | 強い振動         |
| `'4'`    | 約125Hz          | 90%          | 連続振動         |
| その他    | -                | 0%           | モーター停止     |

---

## 🧭 キャリブレーション

プログラム開始時に自動実行され、地磁気・ジャイロのオフセットや曲げセンサの初期値を取得・補正します。

---

## 🔄 処理周期とスムージング

- 処理周期：1msごとのループ実行（約100Hz）  
- 各種センサ値に対してフィルタ係数を用いた平滑化処理あり  
- 姿勢角の推定には Madgwick フィルタを使用

---

## 🚀 セットアップコード例

```cpp
void setup() {
  Serial.begin(9600);       // デバッグ用
  Serial1.begin(9600);      // 外部機器との通信
  pinMode(motorPin, OUTPUT);
  initializeIMU();
  delay(100);
}
```

## 📚 使用ライブラリ

| ライブラリ名         | 説明                        | インストール方法                                     |
|----------------------|-----------------------------|------------------------------------------------------|
| Arduino_LSM9DS1      | IMU（加速度・ジャイロ・地磁気）センサ用 | Arduino IDE → ライブラリマネージャから検索して導入 |
| MadgwickAHRS         | 姿勢推定アルゴリズム        | Arduino IDE → ライブラリマネージャから検索して導入 |

---

## 📝 ライセンス

このプロジェクトは [MIT License](https://opensource.org/licenses/MIT) のもとで公開されています。


